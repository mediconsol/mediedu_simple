#!/bin/bash
set -e

echo "=== Railway Deployment Started ==="
echo "DATABASE_URL: ${DATABASE_URL:0:30}..." # Î≥¥ÏïàÏÉÅ ÏùºÎ∂ÄÎßå Ï∂úÎ†•
echo "RAILS_ENV: $RAILS_ENV"
echo "PORT: $PORT"

# Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå Ï≤òÎ¶¨
if [ -n "$DATABASE_URL" ]; then
  echo "üîó PostgreSQL detected, setting up database..."
  
  # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÎåÄÍ∏∞
  echo "Waiting for database to be ready..."
  sleep 5
  
  # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÉùÏÑ± (ÌïÑÏöîÏãú)
  echo "Creating database if needed..."
  bundle exec rails db:create 2>/dev/null || echo "Database already exists"
  
  # ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
  echo "Running migrations..."
  bundle exec rails db:migrate
  
  # ÏãúÎìú Îç∞Ïù¥ÌÑ∞
  echo "Loading seed data..."
  bundle exec rails db:seed 2>/dev/null || echo "Seed already loaded"
else
  echo "‚ö†Ô∏è  No DATABASE_URL found, using SQLite"
fi

echo "=== Starting Rails server on port $PORT ==="
exec "$@"